# セキュリティ

pi-issue-runnerは、GitHub Issueの内容を安全に処理するためのセキュリティ機能を備えています。

## 概要

GitHub Issueの本文は外部からの入力であり、悪意のあるコードが含まれる可能性があります。pi-issue-runnerは、プロンプトインジェクション攻撃やシェルコマンドインジェクションを防ぐため、Issue本文のサニタイズ機能を実装しています。

## 脅威モデル

### プロンプトインジェクション

Issue本文にシェルで解釈される特殊なパターンが含まれている場合、意図しないコマンドが実行される可能性があります。

**例:**
```
Issue本文に $(rm -rf /) が含まれている場合、
展開されると危険なコマンドが実行される可能性がある
```

## セキュリティ機能

### 1. 危険なパターンの検出

`has_dangerous_patterns()` 関数は、以下の危険なパターンを検出します：

| パターン | 説明 | 例 |
|----------|------|-----|
| `$(...)` | コマンド置換 | `$(whoami)` |
| `` `...` `` | バッククォートによるコマンド置換 | `` `whoami` `` |
| `${...}` | 変数展開 | `${HOME}` |

危険なパターンが検出された場合、ログに警告が出力されます。

### 2. Issue本文のサニタイズ

`sanitize_issue_body()` 関数は、危険なパターンをエスケープして安全な形式に変換します：

| 元のパターン | 変換後 |
|-------------|--------|
| `$(` | `\$(` |
| `` ` `` | `` \` `` |
| `${` | `\${` |

これにより、Issue本文がシェルやテンプレートエンジンで処理される際に、特殊文字として解釈されることを防ぎます。

## 実装詳細

セキュリティ機能は `lib/github.sh` に実装されています。

### has_dangerous_patterns()

```bash
# 使用例
if has_dangerous_patterns "$issue_body"; then
    echo "危険なパターンが検出されました"
fi
```

**戻り値:**
- `0`: 危険なパターンあり（Bash規約でtrue）
- `1`: 安全（危険なパターンなし）

### sanitize_issue_body()

```bash
# 使用例
sanitized_body=$(sanitize_issue_body "$raw_body")
```

**処理フロー:**
1. 入力テキストを受け取る
2. 危険なパターンを検出してログに警告
3. 各パターンをエスケープ文字でエスケープ
4. サニタイズされたテキストを返す

## 使用箇所

サニタイズ機能は以下の場面で使用されます：

- **エージェントテンプレートの展開時**: Issue本文をテンプレート変数として使用する前にサニタイズ
- **プロンプト生成時**: `.pi-prompt.md` ファイルにIssue情報を埋め込む際にサニタイズ

## ベストプラクティス

### ユーザー向け

1. **Issue本文を信頼しない**: 外部からの入力は常に検証・サニタイズする
2. **ログを確認する**: 危険なパターンが検出された場合、警告ログが出力されます

### 開発者向け

1. **Issue本文を直接使用しない**: 必ず `sanitize_issue_body()` を通してから使用する
2. **新しいパターンの追加**: 新たな危険パターンを発見した場合は `_DANGEROUS_PATTERNS` 配列と検出・サニタイズ関数を更新する

## 制限事項

現在のサニタイズ機能は以下のパターンを対象としています：

- シェルのコマンド置換
- シェルの変数展開

以下のパターンは対象外です（必要に応じて拡張可能）：

- ワイルドカード展開（`*`, `?`）
- プロセス置換（`<(...)`, `>(...)`）
- 算術展開（`$((...))`）

## Hook機能のセキュリティリスク

### evalの使用

hookのインラインコマンドは `eval` を使用して実行されます（`lib/hooks.sh` の `_execute_hook()` 関数）。これは設計上の決定であり、以下のリスクを理解した上で使用してください：

```bash
# lib/hooks.sh:_execute_hook()
_execute_hook() {
    local hook="$1"
    ...
    # インラインコマンドとして実行
    log_debug "Executing inline hook"
    eval "$hook"
}
```

### リスク

1. **任意コード実行**: `.pi-runner.yaml` の `hooks` セクションに定義されたコマンドは、そのまま実行される
2. **信頼されていない設定ファイル**: 悪意のあるリポジトリに含まれる `.pi-runner.yaml` が自動的に読み込まれる可能性がある
3. **環境変数の漏洩**: hook内で環境変数が参照される場合、機密情報が外部に送信される可能性がある

### 推奨事項

1. **信頼できる設定ファイルのみ使用**: `.pi-runner.yaml` は信頼できるソースからのみ取得
2. **hookの内容を確認**: 不明なリポジトリのhook設定は実行前に確認
3. **最小権限の原則**: hookスクリプトには必要最小限の権限のみ付与
4. **機密情報を含むhookは環境変数経由で設定**: 直接ハードコードしない
5. **外部スクリプトファイルを使用する場合はファイルの所有者とパーミッションを確認**

### 例: 安全なhook設定

```yaml
# .pi-runner.yaml
hooks:
  # ✅ 安全: シンプルな通知
  on_success: "echo 'Task completed: #{{issue_number}}'"
  
  # ✅ 安全: 信頼できるスクリプトファイル
  on_error: "./scripts/notify-error.sh"
  
  # ⚠️ 注意: 外部サービスへの送信は機密情報に注意
  on_start: "curl -X POST https://example.com/webhook -d '{\"issue\": \"{{issue_number}}\"}'"
```

## 関連ドキュメント

- [アーキテクチャ](architecture.md) - システム全体の設計
- [設定リファレンス](configuration.md) - 設定オプション
- [Hook機能](hooks.md) - hook の詳細仕様

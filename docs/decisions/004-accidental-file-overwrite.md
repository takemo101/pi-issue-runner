# 004: AIエージェントによるファイル誤上書き事故 (2026-02-10)

## 問題

コミット `56c461e` で `scripts/wait-for-sessions.sh` をスタブから本実装に書き換える作業中、
**無関係な `scripts/run.sh`（647行）が3行のスタブに上書き**されていた。

### 経緯

1. `c717512`（コミットメッセージ: `commit`）で `wait-for-sessions.sh` が353行→3行のスタブに縮小
2. `56c461e` で `wait-for-sessions.sh` を再実装する際、AIエージェントが `run.sh` を誤って上書き
3. `run.sh` は647行→3行に破壊され、プロジェクトのメインエントリーポイントが機能しなくなった

### 根本原因

- AIエージェントが `write` ツールやリダイレクト（`>`）で**対象ファイルを取り違えた**
- コミット前に `git diff --stat` を確認していなかったため、無関係な変更に気づけなかった
- 中間コミット（`commit` というメッセージ）がレビューなしでmainに入った

## 対応

### プロンプトへの対策追加

1. **`agents/implement.md`**: コミット前の安全確認ステップを追加
   - `git diff --stat` でタスクに無関係な変更がないか検証を必須化
   - `write` ツールやリダイレクト（`>`）の危険性を明記
   - 完了条件チェックリストにも追加

2. **`agents/review.md`**: 「意図しない変更の検出」を最優先レビュー項目に追加
   - 行数が大幅に減ったファイルの自動検出コマンドを提供
   - 既知の事故パターンとして注意喚起

## 教訓

- `write` ツールやリダイレクト（`>`）は**ファイル全体を置き換える**破壊的操作であり、対象ファイルの取り違えが致命的
- コミット前の `git diff --stat` 確認は必須。特に行数が大幅に減少したファイルは要注意
- 曖昧なコミットメッセージ（`commit`）は作業が不安定な状態を示唆する

# 003: シグナルファイルによる完了検出 (2026-02-10)

## 問題

マーカー検出がターミナル出力のスクレイピングに依存しており、以下の問題が繰り返し発生していた：

1. **ANSIエスケープコード**: pipe-paneの生出力にカラーコード等が含まれ、完全一致検出に失敗
2. **テンプレート誤検出**: agents/merge.md内のコード例 `echo "###TASK_ERROR_NNN###"` がマーカーとして誤検出
3. **スクロールアウト**: capture-paneのスクロールバック上限を超えるとマーカーが消失
4. **pipe-pane再起動**: 既に出力済みのマーカーはpipe-paneログに含まれない
5. **set -e問題**: マーカー検出コードの複雑さにより、watcher自体が予期せず死亡

improve.shが修正を入れるたびにテンプレートやワークフローが変わり、上記のいずれかが再発していた。

## 対応

### シグナルファイル方式を導入（最優先）

AIが完了/エラー時にファイルを作成し、watcherはファイルの存在だけをチェックする。

```
旧: AI出力テキスト → tmux → pipe-pane → grep → パース → 検出
新: AI が touch signal-complete-NNN → watcher が -f チェック → 検出
```

### 実装

- **シグナルファイルパス**: `.worktrees/.status/signal-complete-{issue}`, `signal-error-{issue}`
- **テンプレート変数**: `{{signal_dir}}` でパスを展開
- **検出優先順位**:
  1. シグナルファイル（最も信頼性が高い）
  2. pipe-pane + grep（高速パス）
  3. capture-paneフォールバック（約30秒間隔）
- **後方互換**: テキストマーカーは引き続きサポート（フォールバック）

### 変更ファイル

- `scripts/watch-session.sh`: Phase 1 にシグナルファイルチェック追加
- `lib/template.sh`: `{{signal_dir}}` 変数追加
- `agents/*.md`: 全テンプレートにシグナルファイル作成手順追加

## 教訓

- ターミナル出力のスクレイピングはプロセス間通信として脆弱すぎる
- ファイルシステムベースのシグナリングは最もシンプルで堅牢
- フォールバックチェーンを持つことで、どの方式が失敗しても検出できる

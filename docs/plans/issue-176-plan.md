# Issue #176 Implementation Plan

## 概要

`lib/status.sh` でステータス情報をJSON形式で保存する際の手動文字列構築を、`jq` を使った堅牢な実装に改善する。`jq` がない環境ではより完全なエスケープ関数を使ったフォールバックを提供する。

## 影響範囲

### 変更するファイル
- `lib/status.sh` - JSON構築ロジックの改善

### テストファイル
- `test/status_test.sh` - 特殊文字エスケープのテスト追加

## 実装ステップ

### Step 1: `json_escape()` ヘルパー関数の追加
- 改行(`\n`)、キャリッジリターン(`\r`)、タブ(`\t`)、ダブルクォート(`"`)、バックスラッシュ(`\`)を正しくエスケープ
- 制御文字も考慮

### Step 2: `build_json_with_jq()` 関数の追加
- `jq` コマンドを使用してJSONを安全に構築
- `--arg` オプションで値を渡すことで自動エスケープ

### Step 3: `build_json_fallback()` 関数の追加
- `jq` がない環境用のフォールバック実装
- `json_escape()` を使用して安全にJSON構築

### Step 4: `save_status()` の改修
- `jq` の可用性をチェック
- 利用可能な場合は `build_json_with_jq()` を使用
- そうでなければ `build_json_fallback()` を使用

### Step 5: テストの追加
- 特殊文字（改行、タブ、クォート、バックスラッシュ）を含むエラーメッセージのテスト
- jqを使った場合とフォールバックの両方をテスト

## テスト方針

1. **単体テスト**: `json_escape()` 関数の個別テスト
2. **統合テスト**: `save_status()` で特殊文字を含むメッセージの保存・読み込み
3. **検証**: 生成されたJSONが `jq` でパース可能であることを確認

## リスクと対策

| リスク | 対策 |
|--------|------|
| 後方互換性の破壊 | 既存のテストを全てパスさせる |
| jqの依存追加 | フォールバック実装を必ず提供 |
| パフォーマンス低下 | jq呼び出しは1回のみに抑える |

## 受け入れ条件

- [x] 特殊文字を含むエラーメッセージでも正しいJSONが生成される
- [x] 改行、タブ、クォート、バックスラッシュが正しくエスケープされる
- [x] jqがない環境でもフォールバックで動作する
- [x] 単体テストが追加されている

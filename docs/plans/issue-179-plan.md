# Implementation Plan: Issue #179

## 概要

`improve.sh` がマーカー `###CREATED_ISSUES###` を検出してもIssue番号を抽出できず、自動実行フェーズに進まない問題を修正する。

原因は `tee` コマンドのバッファリングによるもので、piコマンドの出力がファイルに即時反映されないことが原因と考えられる。

## 影響範囲

- `scripts/improve.sh` - メインの修正対象
- `test/improve_test.sh` - テストの追加（バッファリング関連）

## 実装ステップ

### 1. バッファリング対策の実装

`tee` のバッファリング問題を解決するため、以下のアプローチを実装：

1. **stdbufの使用**（Linuxの場合）
   - `stdbuf -oL` でラインバッファリングを有効化
   
2. **macOSの場合**
   - macOSには標準で `stdbuf` がないため、代替策を検討
   - `unbuffer`（expect-devパッケージ）または別の方法を検討
   - 最終手段として、出力の読み取り前に `sync` + `sleep` で対応

3. **ファイル同期の追加**
   - `sync` コマンドでファイルシステムをフラッシュ
   - 短い待機時間（0.5秒）を追加

### 2. デバッグログの強化

`LOG_LEVEL=DEBUG` で実行時に詳細なログを出力：
- 出力ファイルのパスとサイズ
- マーカー検出結果
- 抽出されたIssue番号

### 3. テストの追加

新規テスト：
- バッファリング対策コードの存在確認
- デバッグログ出力の確認

## テスト方針

1. **単体テスト**
   - `./test/improve_test.sh` - 既存テスト + 新規テストがパスすること
   
2. **手動テスト**
   - `LOG_LEVEL=DEBUG ./scripts/improve.sh --dry-run` で詳細ログを確認
   - macOSとLinux両方で動作確認（可能であれば）

## リスクと対策

| リスク | 対策 |
|--------|------|
| stdbufがmacOSで利用不可 | 条件分岐で対応、代替手段を用意 |
| sync/sleepで遅延発生 | 必要最小限の待機時間（0.5秒）に設定 |
| 既存機能への影響 | 既存テストで回帰を確認 |

## 見積もり

- 調査・設計: 30分 ✓（本計画で完了）
- 実装: 30分
- テスト: 30分
- **合計: 1.5時間**

# Issue #392 実装計画

## 概要

`watch-session.sh` の `handle_error` と `handle_complete` 関数が実質的に未定義状態（空の実装）になっている問題を修正します。

現在の実装では、これらの関数はログ出力のみを行い、実際の処理（ステータス保存、hook実行、クリーンアップなど）は `main()` 関数内に重複して記述されています。

## 問題の詳細

### 現在のコード構造

1. **startup時のマーカーチェック** (lines ~105-130):
   - `handle_error` または `handle_complete` を呼び出す（ただしこれらはログだけ）
   - その後、インラインでクリーンアップロジックを実行

2. **メイン監視ループ** (lines ~145-255):
   - エラー/完了検出時に直接処理を実行（関数を呼ばない）
   - ステータス保存、hook実行、ターミナル起動、クリーンアップなど

### 影響

- コードの重複（同じロジックが2箇所に存在）
- 一貫性の欠如（startup時とループ時で動作が異なる可能性）
- メンテナンス性の低下

## 実装ステップ

### Step 1: `handle_error` 関数の実装

以下の処理を `handle_error` 関数に移動:
- worktreeパスとブランチ名の取得
- エラーステータスの保存 (`save_status`)
- `on_error` hook の実行 (`run_hook`)
- ターミナルの自動起動 (`open_terminal_and_attach`)

### Step 2: `handle_complete` 関数の実装

以下の処理を `handle_complete` 関数に移動:
- worktreeパスとブランチ名の取得
- 完了ステータスの保存 (`save_status`)
- `on_success` hook の実行 (`run_hook`)
- クリーンアップの実行（リトライ付き）
- orphaned worktree のクリーンアップ
- 古い計画書のローテーション

### Step 3: `main()` 関数のリファクタリング

- 重複したインラインコードを削除
- 代わりに `handle_error` / `handle_complete` を呼び出す
- グローバル変数として `cleanup_args` を渡す必要があるため、関数シグネチャを調整

### Step 4: テスト実行

- 既存のテストがすべてパスすることを確認
- 必要に応じてテストを追加

## 影響範囲

- `scripts/watch-session.sh` のみ

## テスト方針

- 既存の `test/scripts/watch-session.bats` を実行
- マーカー検出ロジックは変更しないため、既存テストで十分

## リスクと対策

| リスク | 対策 |
|--------|------|
| 関数の引数が増える | 必要な情報を適切に渡すように修正 |
| グローバル変数への依存 | `cleanup_args` を引数で渡すように変更 |
| 処理順序の変更 | 既存の順序を維持して移動 |

## 完了条件

- [ ] `handle_error` 関数にすべてのエラー処理が集約されている
- [ ] `handle_complete` 関数にすべての完了処理が集約されている
- [ ] `main()` 関数内の重複コードが削除されている
- [ ] すべてのテストがパスしている

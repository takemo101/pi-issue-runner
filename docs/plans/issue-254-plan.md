# Implementation Plan: Issue #254

## 概要

エージェントテンプレート (`agents/merge.md`) に完了マーカー (`###TASK_COMPLETE_{{issue_number}}###`) の出力指示を追加し、自動クリーンアップ機能を正しく動作させる。

## 問題分析

### 現状
- `watch-session.sh` は `###TASK_COMPLETE_<issue_number>###` マーカーを監視
- `agents/merge.md` にはエラーマーカーの出力指示のみ
- 完了マーカーの出力指示がないため、自動クリーンアップが動作しない

### 原因
- エージェントテンプレートの設計時に完了マーカーの出力指示が漏れた

## 影響範囲

### 変更が必要なファイル
- `agents/merge.md` - 完了マーカーの出力指示を追加（最も重要、ワークフローの最終ステップ）

### 変更が不要なファイル
- `agents/plan.md` - 中間ステップなので完了マーカー不要
- `agents/implement.md` - 中間ステップなので完了マーカー不要
- `agents/review.md` - 中間ステップなので完了マーカー不要

## 実装ステップ

### 1. agents/merge.md の修正
「エラー報告」セクションの後に「完了報告」セクションを追加：

```markdown
## 完了報告

タスクが正常に完了したら（PRがマージされた後）、以下のマーカーを出力してください：

\`\`\`
###TASK_COMPLETE_{{issue_number}}###
\`\`\`

これにより、worktree と tmux セッションが自動的にクリーンアップされます。
```

### 2. テスト
- `watch-session.sh` のテストコードを確認し、必要に応じてテストを追加
- 手動テストで完了マーカーが正しく認識されることを確認

## テスト方針

### 既存テストの確認
- `test/scripts/watch-session.bats` の確認

### 手動テスト
- agents/merge.md のフォーマットが正しいことを確認
- テンプレート変数 `{{issue_number}}` が正しく展開されることを確認

## リスクと対策

| リスク | 対策 |
|--------|------|
| マーカーのフォーマットミス | watch-session.sh と同じフォーマットを使用 |
| テンプレート変数の展開失敗 | 他の変数（エラーマーカー）と同じパターンを使用 |

## 見積もり

| 作業 | 時間 |
|------|------|
| 実装 | 5分 |
| テスト確認 | 10分 |
| **合計** | **15分** |

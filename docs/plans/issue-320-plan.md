# Issue #320 実装計画書

## 概要

`scripts/test.sh` のユニットテストを追加する。このスクリプトはプロジェクトのテスト実行を一括管理するスクリプトであり、Batsテストと ShellCheck の両方を実行する機能を持つ。

## 影響範囲

- 新規作成: `test/scripts/test.bats`
- 既存ファイルへの変更なし

## 分析

### `scripts/test.sh` の機能

1. **オプション**
   - `-h, --help`: ヘルプ表示
   - `-v, --verbose`: 詳細ログ表示
   - `-f, --fail-fast`: 最初の失敗で終了
   - `-s, --shellcheck`: ShellCheckのみ実行
   - `-a, --all`: Bats + ShellCheck 両方実行

2. **ターゲット**
   - `lib`: `test/lib/*.bats` のみ実行
   - `scripts`: `test/scripts/*.bats` のみ実行
   - (デフォルト): 全Batsテスト実行

3. **内部関数**
   - `usage()`: 使用方法表示
   - `check_bats()`: batsコマンドの存在確認
   - `check_shellcheck()`: shellcheckコマンドの存在確認
   - `run_shellcheck()`: ShellCheck実行
   - `run_bats_tests()`: Batsテスト実行
   - `main()`: メインエントリーポイント

## 実装ステップ

### 1. テストファイル作成

`test/scripts/test.bats` を新規作成

### 2. 必要なテストケース

| テストケース | 説明 |
|------------|------|
| `--help` オプション | 使用方法が表示される |
| `-h` オプション | `--help` と同等 |
| `-v, --verbose` オプション | 詳細ログが有効になる |
| `-f, --fail-fast` オプション | fail-fastモードが有効になる |
| `--shellcheck` オプション | ShellCheckのみ実行される |
| `--all` オプション | Batsと ShellCheck 両方実行される |
| `lib` ターゲット | lib/*.bats のみ実行 |
| `scripts` ターゲット | scripts/*.bats のみ実行 |
| 無効なオプション | エラーが返される |

### 3. モック戦略

- `bats` コマンドをモック化（実際のテストを実行しないため）
- `shellcheck` コマンドをモック化
- 適切な終了コードを返すように設計

## テスト方針

### モックの使用

実際の `bats` や `shellcheck` を実行すると再帰的にテストが実行される可能性があるため、モックを使用して実行ロジックのみをテストする。

### カバレッジ

- 全オプションのパース
- 各ターゲット指定
- エラーケース（無効オプション、コマンド未インストール）

## リスクと対策

### リスク1: 再帰的テスト実行

`test.sh` をテスト中に実際の `bats` が実行されると、再帰的にテストが呼ばれる可能性がある。

**対策**: bats/shellcheck コマンドをモック化

### リスク2: 実際のファイル操作

テスト中に実際のプロジェクトファイルを変更するリスク。

**対策**: テスト用一時ディレクトリを使用、モックで外部コマンドを隔離

## 見積もり

約1時間

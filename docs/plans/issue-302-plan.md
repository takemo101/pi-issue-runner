# Issue #302 実装計画書

## 概要

`watch-session.sh` がagentテンプレート内の `###TASK_ERROR_{{issue_number}}###` 例示テキストをエラーマーカーとして誤検出する問題を修正する。

## 問題分析

### 原因

1. `agents/*.md` テンプレートにエラーマーカーの使用例が記載されている
2. テンプレート変数 `{{issue_number}}` が実際のIssue番号に置換される
3. `watch-session.sh` は10秒の初期待機後、tmux出力をキャプチャしてベースラインを取得
4. キャプチャされた出力にはプロンプト内のエラーマーカー例示が含まれている
5. `grep -qF "$error_marker"` が例示テキストにマッチし、誤検出が発生

### 影響

- watcherがエラー通知を誤送信
- 監視ループは継続するが、完了マーカー検出時に問題が発生する可能性
- ユーザー体験の低下

## 修正案

### 採用案: agentテンプレートの例示形式を変更

agentテンプレート内のマーカー例示を、リテラルマッチを避ける形式に変更する。

**変更方法**: マーカーの説明を記述形式に変更し、実際のマーカーパターンを直接記載しない。

```markdown
## エラー報告

回復不能なエラーが発生した場合は、以下の形式でエラーマーカーを出力してください：

- プレフィックス: `###TASK`
- 中間部: `_ERROR_`
- Issue番号: `{{issue_number}}`
- サフィックス: `###`

（例: 上記を連結して1行で出力し、続けてエラーの説明を記載）

これにより、ユーザーに通知が送信され、手動での対応が可能になります。
```

この形式により:
1. AIエージェントはマーカーの構成方法を理解できる
2. `grep -F` による完全一致検索にマッチしない
3. 人間にとっても読みやすい

## 影響範囲

### 変更対象ファイル

1. `agents/plan.md` - エラー報告セクション
2. `agents/implement.md` - エラー報告セクション
3. `agents/review.md` - エラー報告セクション
4. `agents/merge.md` - エラー報告セクション、完了報告セクション

### 影響しないファイル

- `scripts/watch-session.sh` - 変更不要
- `lib/notify.sh` - 変更不要

## 実装ステップ

1. `agents/plan.md` のエラー報告セクションを修正
2. `agents/implement.md` のエラー報告セクションを修正
3. `agents/review.md` のエラー報告セクションを修正
4. `agents/merge.md` のエラー報告セクションと完了報告セクションを修正
5. 変更をテスト

## テスト方針

### 手動テスト

1. テスト用Issueを作成するか、既存のIssueで `scripts/run.sh <issue-number> --no-attach` を実行
2. watcherが「Error marker already present at startup」を出力しないことを確認
3. 「Starting marker detection...」まで正常に到達することを確認
4. AIエージェントが新しい形式の指示からマーカーを正しく出力できることを確認

### 自動テスト

- 既存のBatsテスト (`test/scripts/watch-session.bats`) が引き続きパスすること

## リスクと対策

### リスク1: AIエージェントがマーカーを正しく出力できなくなる

**対策**: 
- 記述形式は明確で、各部品を連結する指示を含める
- 既存の動作実績（現在のエージェントは正しくマーカーを出力できている）から、問題は発生しにくい

### リスク2: 変更後もマーカー誤検出が発生する

**対策**:
- 変更後のテンプレートに `###TASK_ERROR` や `###TASK_COMPLETE` の文字列が含まれないことを確認
- 手動テストで検証

## 完了条件

- [ ] 全てのagentテンプレートを修正
- [ ] 手動テストで誤検出が解消されたことを確認
- [ ] 既存のBatsテストがパス
- [ ] 変更をコミット

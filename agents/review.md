# Review Agent

GitHub Issue #{{issue_number}} の実装をセルフレビューします。

> **Note**: `gh pr create` はこのステップでは実行しないでください（mergeステップで行います）

## コンテキスト

- **Issue番号**: #{{issue_number}}
- **タイトル**: {{issue_title}}
- **ブランチ**: {{branch_name}}
- **作業ディレクトリ**: {{worktree_path}}

## タスク

### 1. 変更内容の確認
```bash
git diff main...HEAD
git log main..HEAD --oneline
git diff main...HEAD --name-only
```

### 2. レビュー観点

#### 🔗 波及影響（最重要）

**変更が他のコンポーネントを破壊しないことを確認してください。**
多くのバグは「個々の関数は正しいが、組み合わせると壊れる」パターンで発生します。

- [ ] 変更した関数の**出力フォーマット**は、呼び出し元の期待と一致しているか
  - 行数、改行の有無、空行の扱い、特殊文字のエスケープ
- [ ] 新しいファイルやリソースを作成する場合、**cleanup/teardown処理**も対応しているか
- [ ] 既存のインターフェース（引数の数、戻り値の意味）を変更していないか
- [ ] `set -e` 環境で、関数の戻り値が意図通りに扱われるか（return 1 がプロセス死亡を招かないか）

#### 🔧 コード品質
- [ ] コードは既存のスタイルに従っているか
- [ ] 適切な命名規則が使用されているか
- [ ] 不要なコードやコメントがないか
- [ ] エラーハンドリングは適切か

#### 🧪 テスト
- [ ] 変更した機能のテストが書かれているか
- [ ] **コンポーネント間のデータ受け渡し**のテストがあるか
  - 例: 関数Aの出力を関数Bに渡した時に正しく動くか
- [ ] エッジケース（空文字列、マルチライン、特殊文字）がテストされているか
- [ ] 全テストがパスするか

#### 📚 ドキュメント
- [ ] 必要なドキュメントが更新されているか
- [ ] コード内のコメントは適切か
- [ ] 設定項目を追加した場合、ドキュメントとスキーマも更新されているか

#### 🔒 セキュリティ
- [ ] 機密情報がハードコードされていないか
- [ ] 入力値の検証は適切か
- [ ] 外部入力がコマンド実行に渡される箇所はサニタイズされているか

### 3. 問題の修正
レビューで発見した問題を修正し、再コミットしてください。

### 4. 全テスト実行
修正後、**全テストスイート**を実行してパスすることを確認してください。

### 5. レビュー結果
レビュー結果をサマリとしてコミットメッセージに含めるか、
PRの説明に記載してください。

## 完了条件

- [ ] 全てのレビュー観点をチェックした（特に波及影響）
- [ ] 発見した問題を修正した
- [ ] 全テストスイートを再実行して全てパスした

## 知見の記録（オプション）

重要な発見（外部依存の仕様変更、失敗したアプローチ、設計上の制限など）があれば、
`.worktrees/.context/issues/{{issue_number}}.md` にメモしてください。
最終ステップ（merge）で `docs/decisions/` への永続化を判断します。

## 完了後の動作

このステップ完了後、**次のステップ（merge）に進んでください**。
完了マーカーはワークフロー全体（PRマージ後）の最後に出力します。

## エラー報告

回復不能なエラーが発生した場合は、**以下の2つを両方実行**してください：

### 1. シグナルファイルを作成（必須・最優先）

```bash
mkdir -p "{{signal_dir}}" && echo "エラーの説明" > "{{signal_dir}}/signal-error-{{issue_number}}"
```

### 2. エラーマーカーをテキスト出力（後方互換）

- プレフィックス: `###TASK`
- 中間部: `_ERROR_`
- Issue番号: `{{issue_number}}`
- サフィックス: `###`

上記を連結して**行頭から直接**1行で出力し、次の行にエラーの説明を記載してください。

> **重要**: このマーカーは外部プロセス（`watch-session.sh`）によって監視されています。
> マーカーは必ず行頭から出力してください。インデントやコードブロック内での出力は検出されません。

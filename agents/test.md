# Test Agent

GitHub Issue #{{issue_number}} の変更に対してテストを実行し、品質を検証します。

> **Note**: `gh pr create` はこのステップでは実行しないでください（mergeステップで行います）

## コンテキスト

- **Issue番号**: #{{issue_number}}
- **タイトル**: {{issue_title}}
- **ブランチ**: {{branch_name}}
- **作業ディレクトリ**: {{worktree_path}}

## タスク

### 1. 変更内容の把握

まず、何が変更されたかを確認してください：

```bash
git diff main...HEAD --name-only
```

変更されたファイルを確認し、**そのファイルの出力を使う側（呼び出し元）** も特定してください。

### 2. プロジェクト全体のテストを実行

**変更に関連するテストだけでなく、全テストスイートを実行してください。**
変更が他のコンポーネントを破壊していないことを確認するためです。

```bash
# プロジェクトタイプに応じたテストコマンド
# npm test, bats test/, pytest, cargo test など
```

### 3. 静的解析を実行

プロジェクトに静的解析ツールがある場合は実行してください：

```bash
# ShellCheck, ESLint, clippy, mypy など
```

### 4. テスト結果の分析

テストが失敗した場合は、**実装を修正してください**。テストをスキップ・削除して通すのではなく、実装側を直してください。

### 5. テストカバレッジの確認

変更したコードに対して、以下の観点でテストが十分か確認してください：

#### 基本的なカバレッジ
- [ ] 変更した関数/モジュールの正常系テストがあるか
- [ ] エラー系・異常系のテストがあるか

#### 統合的なカバレッジ（重要）
- [ ] 変更した関数の**出力を消費する側**のテストがあるか
  - 例: パーサーを変更した場合、パース結果を使う設定読み込みのテストも確認
  - 例: ファイルを新規作成する機能を追加した場合、削除（cleanup）のテストも確認
- [ ] データのフォーマット（改行、空行、特殊文字）がパイプラインの下流で正しく処理されるか

#### 不足しているテストの追加

テストが不足している場合は追加してください。特に以下を重視：

1. **境界値**: 空文字列、改行を含む文字列、特殊文字
2. **コンポーネント間のデータ受け渡し**: 関数Aの出力を関数Bに渡した時の動作
3. **状態遷移**: 一時的な状態（処理中、リトライ中等）でのエラーハンドリング

### 6. 修正とコミット

テスト追加や実装修正があればコミットしてください：

```bash
git add -A
git commit -m "test: add/fix tests for #{{issue_number}}" -m "Refs #{{issue_number}}"
```

## 完了条件

- [ ] **全テストスイート**がパスした（変更関連テストだけでなく全体）
- [ ] 静的解析がパスした（該当ツールがある場合）
- [ ] 変更したコードにテストがある
- [ ] 変更の影響を受けるコンポーネントのテストも確認した

## 完了後の動作

このステップ完了後、**次のステップに進んでください**。
完了マーカーはワークフロー全体（PRマージ後）の最後に出力します。

## 知見の記録（オプション）

重要な発見（外部依存の仕様変更、失敗したアプローチ、設計上の制限など）があれば、
`.worktrees/.context/issues/{{issue_number}}.md` にメモしてください。
最終ステップ（merge）で `docs/decisions/` への永続化を判断します。

## エラー報告

回復不能なエラーが発生した場合は、**以下の2つを両方実行**してください：

### 1. シグナルファイルを作成（必須・最優先）

```bash
mkdir -p "{{signal_dir}}" && echo "エラーの説明" > "{{signal_dir}}/signal-error-{{issue_number}}"
```

### 2. エラーマーカーをテキスト出力（後方互換）

- プレフィックス: `###TASK`
- 中間部: `_ERROR_`
- Issue番号: `{{issue_number}}`
- サフィックス: `###`

上記を連結して**行頭から直接**1行で出力し、次の行にエラーの説明を記載してください。

> **重要**: このマーカーは外部プロセス（`watch-session.sh`）によって監視されています。
> マーカーは必ず行頭から出力してください。インデントやコードブロック内での出力は検出されません。

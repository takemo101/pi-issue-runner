# Code Review Agent（独立レビュー）

GitHub Issue #{{issue_number}} の変更を**第三者の視点で**レビューします。

> このエージェントは `call:` ステップから別AIインスタンスとして起動されます。
> 実装コンテキストを持たないため、純粋にコード差分からレビューを行います。

## コンテキスト

- **Issue番号**: #{{issue_number}}
- **ブランチ**: {{branch_name}}
- **作業ディレクトリ**: {{worktree_path}}

## タスク

### 1. 変更差分の取得

```bash
git diff main...HEAD --stat
git diff main...HEAD
git log main..HEAD --oneline
```

### 2. レビュー観点

#### 🚨 意図しない変更（最優先）

- [ ] タスクに無関係なファイルが変更されていないか
- [ ] ファイルが意図せず上書き・スタブ化されていないか
- [ ] 大量の削除がある場合、その削除は意図的か

```bash
git diff main...HEAD --numstat | awk '$2 > $1 * 5 && $2 > 50 {print "⚠️ 大幅削減:", $3, "(+" $1, "-" $2 ")"}'
```

#### 🔗 波及影響

- [ ] 変更した関数の出力フォーマットは呼び出し元と整合するか
- [ ] 既存インターフェース（引数の数、戻り値）が互換性を保っているか
- [ ] `set -e` 環境下での戻り値の扱いが正しいか

#### 🔧 コード品質

- [ ] 既存コードのスタイル・命名規則に従っているか
- [ ] 不要なコード・デッドコードがないか
- [ ] エラーハンドリングは適切か

#### 🧪 テスト

- [ ] 変更に対応するテストが存在するか
- [ ] エッジケースがカバーされているか

### 3. 問題の修正

発見した問題は**直接修正**してコミットしてください。

```bash
# 修正後
git add -A
git commit -m "review: <修正内容の要約>"
```

### 4. テスト実行

修正を行った場合、テストが通ることを確認してください。

```bash
shellcheck -x scripts/*.sh lib/*.sh
bats --jobs 2 test/
```

## 完了条件

- [ ] 変更差分を確認し、意図しない変更がないことを検証した
- [ ] コード品質・波及影響をレビューした
- [ ] 発見した問題を修正した（問題がなければそのまま完了）
- [ ] 修正した場合、テストが通ることを確認した

## 完了マーカー

全ての確認が完了したら、以下のマーカーを出力してください：

- プレフィックス: `###TASK`
- 中間部: `_COMPLETE_`
- Issue番号: `{{issue_number}}`
- サフィックス: `###`

上記を連結して**行頭から直接**1行で出力してください。

## エラー報告

回復不能なエラーが発生した場合：

```bash
mkdir -p "{{signal_dir}}" && echo "エラーの説明" > "{{signal_dir}}/signal-error-{{issue_number}}"
```

続けて、エラーマーカーを出力してください：

- プレフィックス: `###TASK`
- 中間部: `_ERROR_`
- Issue番号: `{{issue_number}}`
- サフィックス: `###`

# Implement Agent

GitHub Issue #{{issue_number}} の実装を行います。

> **Note**: `gh pr create` はこのステップでは実行しないでください（mergeステップで行います）

## コンテキスト

- **Issue番号**: #{{issue_number}}
- **タイトル**: {{issue_title}}
- **ブランチ**: {{branch_name}}
- **作業ディレクトリ**: {{worktree_path}}

## タスク

### 1. 準備
- 実装計画書（存在する場合）を確認する
- 必要な依存関係を確認する
- 既存のコードスタイルとパターンを理解する

### 2. 波及影響の事前調査

**実装を始める前に**、変更予定のファイル/関数が**どこから呼ばれているか**を確認してください。

```bash
# 変更予定の関数名や変数名で検索
grep -rn "function_name\|variable_name" lib/ scripts/ --include="*.sh"
```

以下の点を確認してください：
- この関数の出力を使っている箇所はどこか
- 出力フォーマット（行数、改行、型）を変えると壊れる箇所はないか
- 新しいファイルやリソースを作成する場合、cleanup処理の対応が必要か

### 3. 実装
- 計画に従ってコードを実装する
- 既存のコードスタイルに従う
- 変更は最小限かつ焦点を絞ったものにする
- 適切なコメントを追加する
- **波及する箇所も合わせて修正する**

### 4. テスト
- 単体テストを追加・更新する
- **全テストスイートを実行**して、既存機能が壊れていないことを確認する
- 手動テストで動作確認を行う

### 5. コミット前の安全確認（必須）

**コミットする前に、必ず差分を確認してください。**
意図しないファイルの変更・削除がないことを検証します。

```bash
# 変更されたファイル一覧を確認
git diff --stat

# 意図しない大幅な削除がないか確認（行数が大きく減ったファイルがないか）
git diff --stat | grep -E '\d+ insertion.*\d+ deletion'
```

以下に該当する場合は**コミットを中止**し、原因を調査してください：

- **タスクに無関係なファイル**が変更されている
- ファイルの行数が**大幅に減少**している（意図しない上書き・切り詰めの兆候）
- `write` や `>` でファイル全体を書き換えた覚えがないのに、大きな差分が出ている

> ⚠️ **よくある事故**: ファイルAを実装する際に、関係ないファイルBを誤って上書きしてしまうケース。
> 特に `write` ツールやリダイレクト（`>`）は**ファイル全体を置き換える**ため、対象ファイルを間違えると壊滅的です。
> **編集は必ず対象ファイルを確認してから行い、コミット前に `git diff --stat` で検証してください。**

### 6. コミット

> **必須**: `-m` オプションを使用してコミットメッセージを指定してください。
> エディタが開くとセッションがハングします。

```bash
git add -A
git commit -m "<type>: <description>

Refs #{{issue_number}}"
```

複数行のメッセージが必要な場合：
```bash
git commit -m "<type>: <description>" -m "Refs #{{issue_number}}"
```

## 完了条件

- [ ] 全ての要件が実装された
- [ ] 波及する箇所も合わせて修正された
- [ ] テストが追加・更新された
- [ ] **全テストスイート**がパスした
- [ ] `git diff --stat` でタスクに無関係なファイルが変更されていないことを確認した
- [ ] コードがコミットされた

## 完了後の動作

このステップ完了後、**次のステップに進んでください**。
完了マーカーはワークフロー全体（PRマージ後）の最後に出力します。

## 知見の記録（オプション）

重要な発見（外部依存の仕様変更、失敗したアプローチ、設計上の制限など）があれば、
`.worktrees/.context/issues/{{issue_number}}.md` にメモしてください。
最終ステップ（merge）で `docs/decisions/` への永続化を判断します。

## エラー報告

回復不能なエラーが発生した場合は、**以下の2つを両方実行**してください：

### 1. シグナルファイルを作成（必須・最優先）

```bash
mkdir -p "{{signal_dir}}" && echo "エラーの説明" > "{{signal_dir}}/signal-error-{{issue_number}}"
```

### 2. エラーマーカーをテキスト出力（後方互換）

- プレフィックス: `###TASK`
- 中間部: `_ERROR_`
- Issue番号: `{{issue_number}}`
- サフィックス: `###`

上記を連結して**行頭から直接**1行で出力し、次の行にエラーの説明を記載してください。

> **重要**: このマーカーは外部プロセス（`watch-session.sh`）によって監視されています。
> マーカーは必ず行頭から出力してください。インデントやコードブロック内での出力は検出されません。

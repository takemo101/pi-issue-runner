{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/takemo101/pi-issue-runner/schemas/pi-runner.schema.json",
  "title": "pi-issue-runner configuration",
  "description": "Configuration file schema for .pi-runner.yaml",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "worktree": {
      "type": "object",
      "description": "Git worktree settings",
      "additionalProperties": false,
      "properties": {
        "base_dir": {
          "type": "string",
          "default": ".worktrees",
          "description": "Directory where worktrees are created"
        },
        "base_branch": {
          "type": "string",
          "default": "HEAD",
          "description": "Default base branch for worktree creation"
        },
        "copy_files": {
          "type": "array",
          "items": { "type": "string" },
          "default": [".env", ".env.local", ".envrc"],
          "description": "Files to copy into new worktrees"
        }
      }
    },
    "multiplexer": {
      "type": "object",
      "description": "Terminal multiplexer settings",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["tmux", "zellij"],
          "default": "tmux",
          "description": "Multiplexer to use"
        },
        "session_prefix": {
          "type": "string",
          "default": "pi",
          "description": "Session name prefix (session name: {prefix}-issue-{number})"
        },
        "start_in_session": {
          "type": "boolean",
          "default": true,
          "description": "Whether to start inside a multiplexer session"
        }
      }
    },
    "pi": {
      "type": "object",
      "description": "Pi command settings (legacy, use 'agent' for new projects)",
      "additionalProperties": false,
      "properties": {
        "command": {
          "type": "string",
          "default": "pi",
          "description": "Path to the pi command"
        },
        "args": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Additional arguments to pass to pi"
        }
      }
    },
    "agent": {
      "type": "object",
      "description": "Coding agent settings (multi-agent support)",
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["pi", "claude", "opencode", "custom"],
          "description": "Agent preset"
        },
        "command": {
          "type": "string",
          "description": "Custom agent command (for type: custom)"
        },
        "args": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Additional arguments to pass to the agent"
        },
        "template": {
          "type": "string",
          "description": "Command template for custom agents (e.g., '{{command}} {{args}} --file \"{{prompt_file}}\"')"
        }
      }
    },
    "parallel": {
      "type": "object",
      "description": "Parallel execution settings",
      "additionalProperties": false,
      "properties": {
        "max_concurrent": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Maximum concurrent sessions (0 = unlimited)"
        }
      }
    },
    "workflow": {
      "type": "object",
      "description": "Default workflow (used when -w is not specified)",
      "additionalProperties": false,
      "properties": {
        "steps": {
          "type": "array",
          "items": { "type": "string" },
          "default": ["plan", "implement", "review", "merge"],
          "description": "Steps to execute"
        }
      }
    },
    "workflows": {
      "type": "object",
      "description": "Named workflows (selected with -w NAME or -w auto)",
      "additionalProperties": {
        "$ref": "#/definitions/namedWorkflow"
      }
    },
    "plans": {
      "type": "object",
      "description": "Plan document settings",
      "additionalProperties": false,
      "properties": {
        "keep_recent": {
          "type": "integer",
          "minimum": 0,
          "default": 10,
          "description": "Number of recent plans to keep (0 = keep all)"
        },
        "dir": {
          "type": "string",
          "default": "docs/plans",
          "description": "Directory for plan documents"
        }
      }
    },
    "improve": {
      "type": "object",
      "description": "Improve workflow settings (review prompt and logs)",
      "additionalProperties": false,
      "properties": {
        "review_prompt_file": {
          "type": "string",
          "description": "Custom review prompt template file path. Template variables: {{max_issues}}, {{session_label}}, {{review_context}}"
        },
        "logs": {
          "type": "object",
          "description": "Improve logs cleanup settings",
          "additionalProperties": false,
          "properties": {
            "keep_recent": {
              "type": "integer",
              "minimum": 0,
              "default": 10,
              "description": "Number of recent log files to keep (0 = keep all)"
            },
            "keep_days": {
              "type": "integer",
              "minimum": 0,
              "default": 7,
              "description": "Keep logs within N days (0 = no limit)"
            },
            "dir": {
              "type": "string",
              "default": ".improve-logs",
              "description": "Log file directory"
            }
          }
        }
      }
    },
    "improve_logs": {
      "type": "object",
      "description": "Improve logs cleanup settings (deprecated: use improve.logs instead)",
      "additionalProperties": false,
      "properties": {
        "keep_recent": {
          "type": "integer",
          "minimum": 0,
          "default": 10,
          "description": "Number of recent log files to keep (0 = keep all)"
        },
        "keep_days": {
          "type": "integer",
          "minimum": 0,
          "default": 7,
          "description": "Keep logs within N days (0 = no limit)"
        },
        "dir": {
          "type": "string",
          "default": ".improve-logs",
          "description": "Log file directory"
        }
      }
    },
    "github": {
      "type": "object",
      "description": "GitHub integration settings",
      "additionalProperties": false,
      "properties": {
        "include_comments": {
          "type": "boolean",
          "default": true,
          "description": "Include issue comments in prompts"
        },
        "max_comments": {
          "type": "integer",
          "minimum": 0,
          "default": 10,
          "description": "Maximum number of comments to include (0 = unlimited)"
        }
      }
    },
    "hooks": {
      "type": "object",
      "description": "Lifecycle hook scripts",
      "additionalProperties": false,
      "properties": {
        "allow_inline": {
          "type": "boolean",
          "default": false,
          "description": "Allow inline hook commands (set to true when defining inline hooks in .pi-runner.yaml)"
        },
        "on_start": {
          "type": "string",
          "description": "Script/command to run on session start"
        },
        "on_success": {
          "type": "string",
          "description": "Script/command to run on session success"
        },
        "on_error": {
          "type": "string",
          "description": "Script/command to run on session error"
        },
        "on_cleanup": {
          "type": "string",
          "description": "Script/command to run on cleanup"
        },
        "on_improve_start": {
          "type": "string",
          "description": "Script/command to run when improve.sh starts"
        },
        "on_improve_end": {
          "type": "string",
          "description": "Script/command to run when improve.sh ends"
        },
        "on_iteration_start": {
          "type": "string",
          "description": "Script/command to run when each iteration starts"
        },
        "on_iteration_end": {
          "type": "string",
          "description": "Script/command to run when each iteration completes"
        },
        "on_review_complete": {
          "type": "string",
          "description": "Script/command to run when review completes before creating issues"
        }
      }
    },
    "agents": {
      "type": "object",
      "description": "Agent template file paths per step",
      "additionalProperties": { "type": "string" },
      "properties": {
        "plan": {
          "type": "string",
          "description": "Template file for plan step"
        },
        "implement": {
          "type": "string",
          "description": "Template file for implement step"
        },
        "review": {
          "type": "string",
          "description": "Template file for review step"
        },
        "merge": {
          "type": "string",
          "description": "Template file for merge step"
        },
        "test": {
          "type": "string",
          "description": "Template file for test step"
        },
        "ci-fix": {
          "type": "string",
          "description": "Template file for ci-fix step"
        }
      }
    },
    "auto": {
      "type": "object",
      "description": "AI auto-selection settings for -w auto",
      "additionalProperties": false,
      "properties": {
        "provider": {
          "type": "string",
          "description": "AI provider (default: inferred from agent settings or 'anthropic')"
        },
        "model": {
          "type": "string",
          "description": "Model for auto-selection (default: claude-haiku-4-5)"
        }
      }
    },
    "gates": {
      "type": "array",
      "description": "Global quality gates (used when workflow-specific gates are not defined)",
      "items": {
        "$ref": "#/definitions/gateItem"
      }
    },
    "tracker": {
      "type": "object",
      "description": "Prompt tracker settings",
      "additionalProperties": false,
      "properties": {
        "file": {
          "type": "string",
          "default": ".worktrees/.status/tracker.jsonl",
          "description": "Path to the tracker JSONL file"
        }
      }
    },
    "watcher": {
      "type": "object",
      "description": "Session watcher settings",
      "additionalProperties": false,
      "properties": {
        "force_cleanup_on_timeout": {
          "type": "boolean",
          "default": false,
          "description": "Force cleanup on PR merge timeout"
        },
        "initial_delay": {
          "type": "integer",
          "minimum": 0,
          "default": 10,
          "description": "Initial delay in seconds before starting to monitor the session"
        },
        "cleanup_delay": {
          "type": "integer",
          "minimum": 0,
          "default": 5,
          "description": "Delay in seconds before cleanup to ensure session is fully terminated"
        },
        "cleanup_retry_interval": {
          "type": "integer",
          "minimum": 1,
          "default": 3,
          "description": "Interval in seconds between cleanup retry attempts"
        },
        "pr_merge_max_attempts": {
          "type": "integer",
          "minimum": 1,
          "default": 10,
          "description": "Maximum number of attempts to check PR merge status"
        },
        "pr_merge_retry_interval": {
          "type": "integer",
          "minimum": 1,
          "default": 60,
          "description": "Interval in seconds between PR merge check retries"
        }
      }
    }
  },
  "definitions": {
    "gateItem": {
      "oneOf": [
        {
          "type": "string",
          "description": "Simple gate: shell command string (exit 0 = pass)"
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "command": {
              "type": "string",
              "description": "Shell command to execute"
            },
            "call": {
              "type": "string",
              "description": "Workflow name to invoke as a gate (runs in separate AI instance)"
            },
            "timeout": {
              "type": "integer",
              "minimum": 1,
              "default": 300,
              "description": "Timeout in seconds"
            },
            "max_retry": {
              "type": "integer",
              "minimum": 0,
              "default": 0,
              "description": "Maximum retry attempts on failure"
            },
            "retry_interval": {
              "type": "integer",
              "minimum": 0,
              "default": 10,
              "description": "Seconds between retries"
            },
            "continue_on_fail": {
              "type": "boolean",
              "default": false,
              "description": "Continue to next gate even if this one fails"
            },
            "description": {
              "type": "string",
              "description": "Human-readable description for logs"
            }
          }
        }
      ]
    },
    "namedWorkflow": {
      "type": "object",
      "required": ["steps"],
      "additionalProperties": false,
      "properties": {
        "description": {
          "type": "string",
          "description": "Workflow description (used by --list-workflows and -w auto)"
        },
        "steps": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Steps to execute in order"
        },
        "context": {
          "type": "string",
          "description": "Workflow-specific context injected into all step prompts"
        },
        "gates": {
          "type": "array",
          "description": "Quality gates to run after task completion (before PR merge)",
          "items": {
            "$ref": "#/definitions/gateItem"
          }
        },
        "agent": {
          "type": "object",
          "description": "Workflow-specific agent settings (overrides top-level agent)",
          "additionalProperties": false,
          "properties": {
            "type": {
              "type": "string",
              "enum": ["pi", "claude", "opencode", "custom"],
              "description": "Agent preset"
            },
            "command": {
              "type": "string",
              "description": "Custom agent command (for type: custom)"
            },
            "args": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Additional arguments to pass to the agent"
            },
            "template": {
              "type": "string",
              "description": "Command template for custom agents (e.g., '{{command}} {{args}} --file \"{{prompt_file}}\"')"
            }
          }
        }
      }
    }
  }
}

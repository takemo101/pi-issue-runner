name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "."
          severity: warning
          additional_files: "install.sh uninstall.sh"
        env:
          SHELLCHECK_OPTS: "-x"

  unit-tests-lib:
    name: Unit Tests (Lib ${{ matrix.shard }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Shard 1: workflow系 + yaml (~340 tests)
          - shard: "1/4"
            pattern: "workflow*.bats yaml.bats"
          # Shard 2: improve系 + config + status (~350 tests)
          - shard: "2/4"
            pattern: "improve.bats improve/*.bats config.bats status.bats github.bats"
          # Shard 3: multiplexer系 + batch + ci系 (~270 tests)
          - shard: "3/4"
            pattern: "multiplexer*.bats tmux.bats batch.bats ci-*.bats context.bats"
          # Shard 4: その他 (~300 tests)
            # agent, cleanup*, daemon, dashboard, dependency, hooks, log,
            # marker, notify, priority, session-resolver, template, worktree
          - shard: "4/4"
            pattern: "REMAINING"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            /usr/local/bin/bats
            /usr/local/libexec/bats-core
            /usr/local/bin/yq
          key: ${{ runner.os }}-deps-v3

      - name: Install system dependencies
        run: |
          # gh and jq are pre-installed on ubuntu-latest runners
          sudo apt-get update -qq
          sudo apt-get install -y -qq tmux

      - name: Install yq
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          YQ_VERSION="v4.40.5"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Install Bats
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core
          sudo ./install.sh /usr/local

      - name: Resolve test files for shard
        id: resolve
        run: |
          PATTERN="${{ matrix.pattern }}"
          FILES=""

          if [[ "$PATTERN" == "REMAINING" ]]; then
            # Collect files matched by other shards
            MATCHED=""
            MATCHED+=" $(ls test/lib/workflow*.bats test/lib/yaml.bats 2>/dev/null)"
            MATCHED+=" $(ls test/lib/improve.bats 2>/dev/null) $(ls test/lib/improve/*.bats 2>/dev/null)"
            MATCHED+=" $(ls test/lib/config.bats test/lib/status.bats test/lib/github.bats 2>/dev/null)"
            MATCHED+=" $(ls test/lib/multiplexer*.bats test/lib/tmux.bats test/lib/batch.bats 2>/dev/null)"
            MATCHED+=" $(ls test/lib/ci-*.bats test/lib/context.bats 2>/dev/null)"

            # Get all lib test files, exclude matched ones
            for f in test/lib/*.bats; do
              if [[ -f "$f" ]] && ! echo "$MATCHED" | grep -qF "$f"; then
                FILES+="$f "
              fi
            done
          else
            for p in $PATTERN; do
              if [[ "$p" == *"/"* ]]; then
                # Subdirectory pattern (e.g., improve/*.bats)
                for f in test/lib/$p; do
                  [[ -f "$f" ]] && FILES+="$f "
                done
              else
                f="test/lib/$p"
                [[ -f "$f" ]] && FILES+="$f "
              fi
            done
          fi

          echo "files=$FILES" >> "$GITHUB_OUTPUT"
          echo "Shard ${{ matrix.shard }} test files:"
          echo "$FILES" | tr ' ' '\n' | grep -v '^$' | sort

      - name: Run lib unit tests (shard ${{ matrix.shard }})
        run: |
          FILES="${{ steps.resolve.outputs.files }}"
          if [[ -z "$FILES" ]]; then
            echo "No test files for this shard"
            exit 0
          fi
          echo "=== Running Bats tests (lib shard ${{ matrix.shard }}) ==="
          # shellcheck disable=SC2086
          bats --jobs 4 $FILES
        env:
          BATS_FAST_MODE: 1

  unit-tests-scripts:
    name: Unit Tests (Scripts)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            /usr/local/bin/bats
            /usr/local/libexec/bats-core
            /usr/local/bin/yq
          key: ${{ runner.os }}-deps-v3

      - name: Install system dependencies
        run: |
          # gh and jq are pre-installed on ubuntu-latest runners
          sudo apt-get update -qq
          sudo apt-get install -y -qq tmux

      - name: Install yq
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          YQ_VERSION="v4.40.5"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Install Bats
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core
          sudo ./install.sh /usr/local

      - name: Run scripts unit tests
        run: |
          echo "=== Running Bats tests (scripts) ==="
          ./scripts/test.sh scripts
        env:
          BATS_JOBS: 4
          BATS_FAST_MODE: 1

  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            /usr/local/bin/bats
            /usr/local/libexec/bats-core
            /usr/local/bin/yq
          key: ${{ runner.os }}-deps-v3

      - name: Install system dependencies
        run: |
          # gh and jq are pre-installed on ubuntu-latest runners
          sudo apt-get update -qq
          sudo apt-get install -y -qq tmux

      - name: Install yq
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          YQ_VERSION="v4.40.5"
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq

      - name: Install Bats
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats-core
          cd /tmp/bats-core
          sudo ./install.sh /usr/local

      - name: Run regression tests
        run: |
          echo "=== Running Bats tests (regression) ==="
          ./scripts/test.sh regression
        env:
          BATS_JOBS: 4
          BATS_FAST_MODE: 1

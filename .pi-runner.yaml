# pi-issue-runner 設定ファイル
# 詳細: https://github.com/takemo101/pi-issue-runner/blob/main/docs/configuration.md

# =====================================
# Worktree設定
# =====================================
worktree:
  # worktreeの作成先ディレクトリ
  base_dir: ".worktrees"

  # デフォルトのベースブランチ（--base オプションで上書き可能）
  base_branch: "origin/main"

  # worktree作成時にコピーするファイル
  copy_files:
    - .env
    - .env.local
    - .envrc

  # worktree作成時にコピーするディレクトリ（再帰コピー）
  copy_dirs:
    - .opencode

# =====================================
# マルチプレクサ設定
# =====================================
multiplexer:
  # 使用するマルチプレクサ: tmux | zellij
  type: "tmux"

  # セッション名のプレフィックス（例: pi-issue-42）
  session_prefix: "pi"

  # セッション内で起動するか
  start_in_session: true

# =====================================
# エージェント設定
# =====================================
agent:
  # エージェントタイプ: pi | claude | opencode | custom
  type: "pi"

  # エージェントに渡す追加引数
  args:
    - --provider
    - kimi-coding
    - --model
    - k2p5

# =====================================
# GitHub設定
# =====================================
github:
  # Issueのコメントをプロンプトに含める
  include_comments: true

  # 最大コメント数（0 = 無制限）
  max_comments: 10

# =====================================
# 並列実行設定
# =====================================
parallel:
  # 同時実行数の上限（0 = 無制限）
  max_concurrent: 5

# =====================================
# auto ワークフロー選択設定
# =====================================
auto:
  provider: kimi-coding
  model: k2p5

# =====================================
# 複数ワークフロー定義
# -w 省略時は auto（AIがIssue内容から自動選択）
# =====================================
workflows:
  # 標準: 計画→実装→レビュー→マージ
  default:
    description: 標準ワークフロー（計画・実装・レビュー・マージ）
    steps:
      - plan
      - implement:
          context: |
            実装完了後、必ず以下を実行してください：
            1. ShellCheck: `shellcheck -x scripts/*.sh lib/*.sh`
            2. テスト: `bats --jobs 2 test/`
            3. 両方パスしたらコミット・プッシュ
      - review
      - merge

  # 機能追加: 計画→実装→レビュー→マージ
  feature:
    description: 新機能・大規模変更（lib/scripts への新関数追加、新スクリプト作成）
    steps:
      - plan
      - implement:
          context: |
            実装時の方針：
            - 複数ファイルを並列作成する場合は subagent を使用
            - 新しい lib/ には対応する test/lib/*.bats を必ず作成
            - 新しい scripts/ には対応する test/scripts/*.bats を必ず作成

            実装完了後、必ず以下を実行：
            1. ShellCheck: `shellcheck -x scripts/*.sh lib/*.sh`
            2. テスト: `bats --jobs 2 test/`
            3. AGENTS.md のディレクトリ構造を更新
            4. コミット・プッシュ
      - review
      - merge
    context: |
      ## 技術スタック
      - Bash 4.0+ / ShellCheck 準拠
      - テスト: Bats (Bash Automated Testing System)
      - YAML: yq + フォールバック簡易パーサー (lib/yaml.sh)

      ## 方針
      - 全ファイルに `set -euo pipefail` を設定
      - 関数は小文字スネークケース、ローカル変数は `local` 宣言

  # バグ修正・リファクタリング
  fix:
    description: バグ修正・リファクタリング・セキュリティ修正
    steps:
      - implement:
          context: |
            実装時の方針：
            - 修正範囲を最小限に抑える
            - 回帰テスト (test/regression/) の追加を検討

            実装完了後、必ず以下を実行：
            1. ShellCheck: `shellcheck -x scripts/*.sh lib/*.sh`
            2. テスト: `bats --jobs 2 test/`
            3. 既存テストが壊れていないことを確認
            4. コミット・プッシュ
      - review
      - merge
    context: |
      ## 方針
      - ShellCheck 警告を解消すること
      - 既存機能の後方互換性を維持すること

  # ドキュメント: 実装→マージ（軽量モデルで十分）
  docs:
    description: ドキュメント更新（README, AGENTS.md, docs/ 以下）
    steps:
      - implement:
          context: |
            ドキュメント作成時の確認事項：
            - docs/ 以下の既存ドキュメントとの整合性
            - AGENTS.md のディレクトリ構造が実態と一致しているか
            - コード例は実際に動作するものを記載
            
            完了後、コミット・プッシュ
      - merge

  # テスト追加: 実装→レビュー→マージ
  test:
    description: テスト追加・テスト改善
    steps:
      - implement:
          context: |
            テスト作成時の方針：
            - Bats テストの規約に従う（test_helper.bash のモック関数を活用）
            - setup/teardown で環境を確実にクリーンアップ
            - グローバル状態を汚染しない（reset_yaml_cache, _YQ_CHECK_RESULT="" を setup で呼ぶ）

            実装完了後、必ず以下を実行：
            1. ShellCheck: `shellcheck -x scripts/*.sh lib/*.sh`
            2. テスト: `bats --jobs 2 test/`
            3. コミット・プッシュ
      - review
      - merge

  # 簡易修正: 実装→マージのみ（軽微な変更）
  quickfix:
    description: typo修正・設定値変更・コメント修正など軽微な変更
    steps:
      - implement:
          context: |
            軽微な修正のみ行い、コミット・プッシュ
      - merge

  # シンプル: 実装→マージ（テストなし、最速）
  simple:
    description: 最もシンプルなワークフロー（実装のみ）
    steps:
      - implement
      - merge

# =====================================
# 計画書設定
# =====================================
plans:
  # 保持する計画書の件数（0 = 全て保持）
  keep_recent: 10

  # 計画書ディレクトリ
  dir: "docs/plans"

# =====================================
# improve 設定
# =====================================
improve:
  # カスタムレビュープロンプトファイル
  review_prompt_file: "agents/improve-review.md"

  # ログ設定
  logs:
    keep_recent: 10
    keep_days: 7
    dir: ".improve-logs"

# =====================================
# Hook設定
# =====================================
hooks:
  # インラインコマンドの実行を許可（デフォルト: false）
  allow_inline: true

  # 成功時の通知
  on_success: |
    osascript -e 'display notification "Issue #'"$PI_ISSUE_NUMBER"' が完了しました" with title "Pi Issue Runner" subtitle "✅ 完了" sound name "Glass"'

  # エラー時の通知
  on_error: |
    osascript -e 'display notification "'"$PI_ERROR_MESSAGE"'" with title "Pi Issue Runner" subtitle "❌ Issue #'"$PI_ISSUE_NUMBER"' エラー" sound name "Basso"'

  # セッション開始時
  on_start: |
    osascript -e 'display notification "Issue #'"$PI_ISSUE_NUMBER"' を開始しました" with title "Pi Issue Runner" subtitle "🚀 開始" sound name "Pop"'

  # クリーンアップ後
  on_cleanup: |
    echo "Cleanup completed for Issue #$PI_ISSUE_NUMBER"

  # improve開始時
  on_improve_start: |
    osascript -e 'display notification "改善ループを開始します（最大 '"$PI_MAX_ITERATIONS"' 回）" with title "Pi Issue Runner" subtitle "🔄 improve開始" sound name "Pop"'

  # improve終了時
  on_improve_end: |
    osascript -e 'display notification "改善ループ完了: 作成 '"$PI_ISSUES_CREATED"' / 成功 '"$PI_ISSUES_SUCCEEDED"' / 失敗 '"$PI_ISSUES_FAILED"'" with title "Pi Issue Runner" subtitle "🏁 improve終了" sound name "Glass"'

  # イテレーション開始時
  on_iteration_start: |
    osascript -e 'display notification "イテレーション '"$PI_ITERATION"'/'"$PI_MAX_ITERATIONS"' を開始" with title "Pi Issue Runner" subtitle "🔁 イテレーション開始" sound name "Pop"'

  # イテレーション終了時
  on_iteration_end: |
    osascript -e 'display notification "イテレーション '"$PI_ITERATION"'/'"$PI_MAX_ITERATIONS"' 完了: 成功 '"$PI_ISSUES_SUCCEEDED"' / 失敗 '"$PI_ISSUES_FAILED"'" with title "Pi Issue Runner" subtitle "✅ イテレーション終了" sound name "Purr"'

  # レビュー完了時
  on_review_complete: |
    osascript -e 'display notification "レビュー完了: '"$PI_REVIEW_ISSUES_COUNT"' 件の問題を発見" with title "Pi Issue Runner" subtitle "🔍 レビュー完了" sound name "Tink"'

# =====================================
# Watcher設定
# =====================================
watcher:
  # PRマージタイムアウト時に強制クリーンアップ
  force_cleanup_on_timeout: true

  # エラー検知時にターミナルを自動で開いてセッションにアタッチする
  auto_attach: false
